<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ContentHub Calendar</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="page-header">
      <div>
        <p class="eyebrow">{{ current_label }}</p>
        <h1>Content Calendar</h1>
        <p class="subtitle">Drop video hooks on the days you plan to publish and check them off once recorded.</p>
      </div>
      <div class="month-actions">
        <nav class="month-nav">
          <a href="/?year={{ previous[0] }}&month={{ previous[1] }}" aria-label="Previous month">← {{ previous_label }}</a>
          <a class="today-link" href="/">Today</a>
          <a href="/?year={{ next[0] }}&month={{ next[1] }}" aria-label="Next month">{{ next_label }} →</a>
        </nav>
        <a class="snippet-link" href="/snippets">Snippet Library</a>
      </div>
    </header>

    <main>
      <div class="calendar-grid">
        <div class="weekday">Mon</div>
        <div class="weekday">Tue</div>
        <div class="weekday">Wed</div>
        <div class="weekday">Thu</div>
        <div class="weekday">Fri</div>
        <div class="weekday">Sat</div>
        <div class="weekday">Sun</div>
        {% for week in weeks %}
          {% for day in week %}
            {% set ideas = ideas_by_day.get(day, []) %}
            <section class="day-card {% if day.month != current_month %}muted{% endif %} {% if day == today %}today{% endif %}" data-date="{{ day.isoformat() }}">
              <header class="day-head">
                <span class="day-number">{{ day.day }}</span>
                {% if day == today %}<span class="pill">Today</span>{% endif %}
              </header>
              <ul class="ideas">
                {% for idea in ideas %}
                  <li class="idea-row">
                    <label>
                      <input type="checkbox" data-toggle="{{ idea.id }}" {% if idea.completed %}checked{% endif %} />
                      <span class="idea-text {% if idea.completed %}done{% endif %}">{{ idea.title }}</span>
                    </label>
                    <div class="row-actions">
                      <a href="/ideas/{{ idea.id }}/edit" class="tiny-link">Edit</a>
                      <button data-delete="{{ idea.id }}" aria-label="Delete idea">×</button>
                    </div>
                  </li>
                {% endfor %}
              </ul>
              <form class="day-form" data-day-form>
                <input name="title" placeholder="Add idea" autocomplete="off" />
                <button type="button" class="template-btn" data-template-launch aria-label="Insert template" title="Templates">Templates</button>
                <button type="submit">+</button>
              </form>
            </section>
          {% endfor %}
        {% endfor %}
      </div>
    </main>

    <script>
      document.querySelectorAll('[data-day-form]').forEach((form) => {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          const container = form.closest('[data-date]');
          const title = form.elements.title.value.trim();
          if (!title) return;
          const payload = { title, target_date: container.dataset.date };
          const res = await fetch('/api/ideas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (res.ok) {
            form.reset();
            window.location.reload();
          } else {
            alert('Unable to add idea');
          }
        });
      });

      document.querySelectorAll('[data-toggle]').forEach((checkbox) => {
        checkbox.addEventListener('change', async () => {
          const id = checkbox.dataset.toggle;
          const res = await fetch(`/api/ideas/${id}/toggle`, { method: 'POST' });
          if (!res.ok) {
            alert('Unable to update idea');
            checkbox.checked = !checkbox.checked;
          }
        });
      });

      document.querySelectorAll('[data-delete]').forEach((button) => {
        button.addEventListener('click', async () => {
          if (!confirm('Delete this idea?')) return;
          const id = button.dataset.delete;
          const res = await fetch(`/api/ideas/${id}`, { method: 'DELETE' });
          if (res.ok) {
            window.location.reload();
          } else {
            alert('Unable to delete idea');
          }
        });
      });

      const templateState = { loaded: false, items: [], filter: 'all' };
      const popover = document.createElement('div');
      popover.className = 'template-popover hidden';
      popover.innerHTML = `
        <header>
          <h4>Snippets</h4>
          <p>Insert hook formulas or intro scripts.</p>
        </header>
        <div style="margin-bottom:0.5rem;">
          <select data-template-filter style="width:100%;border-radius:10px;border:1px solid #d8defa;padding:0.2rem 0.4rem;font-family:inherit;">
            <option value="all">All categories</option>
            <option value="Hook">Hooks</option>
            <option value="Intro">Intros</option>
            <option value="CTA">CTAs</option>
          </select>
        </div>
        <ul data-template-list></ul>
      `;
      document.body.appendChild(popover);
      const templateList = popover.querySelector('[data-template-list]');
      const templateFilter = popover.querySelector('[data-template-filter]');
      let activeInput = null;

      function formatCategory(category) {
        return category || 'Uncategorized';
      }

      async function ensureTemplates(force = false) {
        if (templateState.loaded && !force) return templateState.items;
        try {
          const res = await fetch('/api/templates');
          if (!res.ok) return [];
          templateState.items = await res.json();
          templateState.loaded = true;
        } catch (error) {
          console.error(error);
        }
        renderTemplateList();
        return templateState.items;
      }

      function renderTemplateList() {
        templateList.innerHTML = '';
        const filtered = templateState.items.filter((tpl) => templateState.filter === 'all' || formatCategory(tpl.category) === templateState.filter);
        if (!filtered.length) {
          const li = document.createElement('li');
          li.innerHTML = '<p style="color:#6b7280;font-size:0.85rem;margin:0;">No templates yet.</p>';
          templateList.appendChild(li);
          return;
        }
        filtered.forEach((tpl) => {
          const li = document.createElement('li');
          const bodyPreview = tpl.body.length > 80 ? `${tpl.body.slice(0, 77)}…` : tpl.body;
          const ratingLabel = tpl.rating != null ? `${tpl.rating.toFixed(1)}★` : 'New';
          li.innerHTML = `
            <div class="popover-item">
              <button type="button" data-template-id="${tpl.id}">
                <strong>${tpl.name}</strong>
                <span>${formatCategory(tpl.category)} • ${ratingLabel}</span>
                <em>${bodyPreview}</em>
              </button>
              <button type="button" class="favorite-toggle" data-template-favorite="${tpl.id}" aria-label="Favorite template">
                ${tpl.favorite ? '★' : '☆'}
              </button>
            </div>
          `;
          templateList.appendChild(li);
        });
      }

      function closePopover() {
        popover.classList.add('hidden');
        activeInput = null;
      }

      async function openPopover(button) {
        const form = button.closest('[data-day-form]');
        if (!form || !form.elements.title) return;
        activeInput = form.elements.title;
        await ensureTemplates();
        renderTemplateList();
        popover.classList.remove('hidden');
        const rect = button.getBoundingClientRect();
        const popoverWidth = popover.offsetWidth || 240;
        const left = Math.min(rect.left + window.scrollX, window.scrollX + window.innerWidth - popoverWidth - 16);
        popover.style.top = `${rect.bottom + window.scrollY + 8}px`;
        popover.style.left = `${Math.max(16, left)}px`;
      }

      templateList.addEventListener('click', (event) => {
        const favoriteTarget = event.target.closest('[data-template-favorite]');
        if (favoriteTarget) {
          const templateId = Number(favoriteTarget.dataset.templateFavorite);
          const template = templateState.items.find((item) => item.id === templateId);
          if (template) {
            toggleTemplateFavorite(templateId, !template.favorite);
          }
          event.stopPropagation();
          return;
        }
        const target = event.target.closest('[data-template-id]');
        if (!target || !activeInput) return;
        const templateId = Number(target.dataset.templateId);
        const template = templateState.items.find((item) => item.id === templateId);
        if (template) {
          activeInput.value = template.body;
          activeInput.focus();
        }
        closePopover();
      });

      document.addEventListener('click', (event) => {
        if (event.target.closest('[data-template-launch]')) return;
        if (popover.contains(event.target)) return;
        closePopover();
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closePopover();
        }
      });

      document.querySelectorAll('[data-template-launch]').forEach((button) => {
        button.addEventListener('click', (event) => {
          event.preventDefault();
          openPopover(button);
        });
      });

      templateFilter.addEventListener('change', (event) => {
        templateState.filter = event.target.value;
        renderTemplateList();
      });

      async function toggleTemplateFavorite(id, favorite) {
        try {
          const res = await fetch(`/api/templates/${id}/favorite`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ favorite }),
          });
          if (!res.ok) throw new Error('Unable to update favorite');
          await ensureTemplates(true);
          renderTemplateList();
        } catch (error) {
          console.error(error);
          alert('Unable to save favorite');
        }
      }
    </script>
  </body>
</html>
